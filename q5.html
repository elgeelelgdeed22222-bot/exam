<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>مدرسة الجيل الجديد الخاصة - امتحان الدراسات الاجتماعية</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Arial', sans-serif;
        }
        
        body {
            background-color: #f5f5f5;
            padding: 10px;
            max-width: 100%;
            overflow-x: hidden;
        }
        
        .header {
            text-align: center;
            background-color: #2c3e50;
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            font-size: 18px;
            margin-bottom: 5px;
        }
        
        .header h2 {
            font-size: 16px;
            color: #f1c40f;
        }
        
        .header h3 {
            font-size: 14px;
            margin-top: 10px;
        }
        
        .container {
            background-color: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .code-input-section {
            text-align: center;
        }
        
        .code-input {
            width: 100%;
            max-width: 300px;
            padding: 12px;
            font-size: 16px;
            text-align: center;
            border: 2px solid #3498db;
            border-radius: 5px;
            margin: 15px 0;
            direction: ltr;
        }
        
        .btn {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            margin: 10px 5px;
            transition: background-color 0.3s;
        }
        
        .btn:hover {
            background-color: #2980b9;
        }
        
        .btn:disabled {
            background-color: #95a5a6;
            cursor: not-allowed;
        }
        
        .question {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background-color: #f9f9f9;
            font-size: 14px;
        }
        
        .question-number {
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 15px;
        }
        
        .options {
            margin-right: 20px;
        }
        
        .option {
            margin-bottom: 8px;
            padding: 8px;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .option:hover {
            background-color: #ecf0f1;
        }
        
        .option.selected {
            background-color: #d6eaf8;
            border-right: 4px solid #3498db;
        }
        
        .submit-btn {
            background-color: #27ae60;
            display: block;
            margin: 20px auto;
            width: 200px;
        }
        
        .submit-btn:hover {
            background-color: #219653;
        }
        
        .result {
            text-align: center;
            padding: 20px;
            background-color: #e8f6f3;
            border-radius: 10px;
            margin-top: 20px;
            font-size: 14px;
        }
        
        .score {
            font-size: 24px;
            color: #27ae60;
            font-weight: bold;
            margin: 15px 0;
        }
        
        .mistakes {
            text-align: right;
            margin-top: 20px;
            padding: 15px;
            background-color: #fdedec;
            border-radius: 8px;
            font-size: 13px;
        }
        
        .mistake-item {
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px dashed #e74c3c;
        }
        
        .correct-answer {
            color: #27ae60;
            font-weight: bold;
        }
        
        .wrong-answer {
            color: #e74c3c;
            font-weight: bold;
        }
        
        .timer {
            position: fixed;
            top: 10px;
            left: 10px;
            background-color: #34495e;
            color: white;
            padding: 8px 12px;
            border-radius: 5px;
            font-size: 14px;
            z-index: 100;
        }
        
        .error-message {
            color: #e74c3c;
            margin-top: 10px;
            font-size: 14px;
            text-align: center;
        }
        
        .info-message {
            color: #3498db;
            margin-top: 10px;
            font-size: 13px;
            text-align: center;
        }
        
        .hidden {
            display: none;
        }
        
        @media (max-width: 768px) {
            body {
                padding: 5px;
            }
            
            .header h1 {
                font-size: 16px;
            }
            
            .header h2 {
                font-size: 14px;
            }
            
            .question {
                font-size: 13px;
            }
            
            .option {
                font-size: 12px;
                padding: 6px;
            }
            
            .result, .mistakes {
                font-size: 12px;
            }
        }
    </style>
</head>
<body>
    <div class="timer" id="timer"></div>
    
    <div class="header">
        <h1>مدرسة الجيل الجديد الخاصة</h1>
        <h2>هذا أول امتحان: امتحان الدراسات الاجتماعية للصف الخامس الابتدائي</h2>
        <h3>امتحان إلكتروني - يسمح بالدخول مرة واحدة فقط لكل كود</h3>
    </div>
    
    <div class="container code-input-section" id="codeSection">
        <p>يرجى إدخال الكود المكون من 9 أرقام (باللغة الإنجليزية):</p>
        <input type="text" id="studentCode" class="code-input" maxlength="9" placeholder="" pattern="\d*" inputmode="numeric">
        <p class="info-message">الكود مكون من 9 أرقام فقط (0-9)</p>
        <button class="btn" id="startExamBtn">بدء الامتحان</button>
        <div class="error-message" id="codeError"></div>
    </div>
    
    <div class="container hidden" id="examSection">
        <div id="questionsContainer"></div>
        <button class="btn submit-btn" id="submitExamBtn">إنهاء الامتحان وتصحيح الإجابات</button>
    </div>
    
    <div class="container hidden" id="resultSection">
        <div id="resultContent"></div>
    </div>

    <script>
        // البيانات الأساسية
        const examData = {
            title: "امتحان الدراسات الاجتماعية للصف الخامس الابتدائي",
            questions: [
                {
                    question: "اعتمد المصريون القدماء في تدفئة منازلهم على ...........",
                    options: ["البترول", "الغاز الطبيعي", "الطاقة الشمسية", "الفحم"],
                    correctAnswer: 2
                },
                {
                    question: "معدن يستخدم في صناعة الأسلاك الكهربائية ...........",
                    options: ["الحديد", "الذهب", "المنجنيز", "النحاس"],
                    correctAnswer: 3
                },
                {
                    question: "يدخل المنجنيز في صناعة ...........",
                    options: ["الأسمدة", "الصلب", "المبيدات", "الأسلاك"],
                    correctAnswer: 1
                },
                {
                    question: "نستفيد من الغاز الطبيعي في ...........",
                    options: ["توليد الكهرباء", "صناعة الأدوية", "استخراج البنزين", "صناعة البلاستيك"],
                    correctAnswer: 0
                },
                {
                    question: "يستخرج البترول في مصر من ...........",
                    options: ["واحة سيوة", "جنوب وادي النيل", "منخفض الفيوم", "شمال الصحراء الغربية"],
                    correctAnswer: 3
                },
                {
                    question: "معدن يُستخرج من منجم أم بجمة في سيناء ...........",
                    options: ["المنجنيز", "الفوسفات", "الحديد", "الذهب"],
                    correctAnswer: 0
                },
                {
                    question: "يدخل الفوسفات في صناعة ...........",
                    options: ["حديد التسليح", "الحلي", "الأسمدة الكيماوية", "السبائك"],
                    correctAnswer: 2
                },
                {
                    question: "يقع منجم السكري في ...........",
                    options: ["وادي النيل", "الصحراء الغربية", "دلتا النيل", "الصحراء الشرقية"],
                    correctAnswer: 3
                },
                {
                    question: "البنزين والسولار من مشتقات ...........",
                    options: ["الغاز الطبيعي", "الفحم", "البترول", "الهيدروجين الأخضر"],
                    correctAnswer: 2
                },
                {
                    question: "إحدى محطات الطاقة الكهرومائية محطة ...........",
                    options: ["الزعفرانة", "خزان أسوان", "قرية بنبان", "الكريمات"],
                    correctAnswer: 1
                }
            ]
        };

        // عناصر DOM
        const codeSection = document.getElementById('codeSection');
        const examSection = document.getElementById('examSection');
        const resultSection = document.getElementById('resultSection');
        const studentCodeInput = document.getElementById('studentCode');
        const startExamBtn = document.getElementById('startExamBtn');
        const submitExamBtn = document.getElementById('submitExamBtn');
        const questionsContainer = document.getElementById('questionsContainer');
        const resultContent = document.getElementById('resultContent');
        const codeError = document.getElementById('codeError');
        const timerElement = document.getElementById('timer');

        // حالة الامتحان
        let examState = {
            studentCode: '',
            answers: new Array(examData.questions.length).fill(null),
            startTime: null,
            examCompleted: false
        };

        // تهيئة التطبيق
        document.addEventListener('DOMContentLoaded', function() {
            // التحقق من الوقت الحالي
            const now = new Date();
            const currentHour = now.getHours();
            
            if (currentHour >= 0 && currentHour < 6) {
                // منتصف الليل حتى 6 صباحًا
                codeError.textContent = "الامتحان غير متاح بعد الساعة 12 منتصف الليل. يرجى المحاولة في وقت لاحق.";
                startExamBtn.disabled = true;
                studentCodeInput.disabled = true;
                return;
            }
            
            // التحقق مما إذا كان الطالب قد دخل من قبل
            checkPreviousAttempts();
            
            // إعداد خانة إدخال الكود
            studentCodeInput.addEventListener('input', function() {
                // السماح بالأرقام الإنجليزية فقط
                this.value = this.value.replace(/[^0-9]/g, '');
                
                if (this.value.length === 9) {
                    codeError.textContent = '';
                    startExamBtn.disabled = false;
                } else {
                    startExamBtn.disabled = true;
                    if (this.value.length > 0) {
                        codeError.textContent = 'الكود يجب أن يتكون من 9 أرقام فقط';
                    }
                }
            });
            
            // زر بدء الامتحان
            startExamBtn.addEventListener('click', startExam);
            
            // زر إنهاء الامتحان
            submitExamBtn.addEventListener('click', submitExam);
            
            // تحديث المؤقت
            updateTimer();
            setInterval(updateTimer, 1000);
        });

        // التحقق من المحاولات السابقة
        function checkPreviousAttempts() {
            // إنشاء مفتاح فريد للهاتف مع رمز مميز
            const deviceKey = generateDeviceKey();
            
            // محاولة الحصول على سجل المحاولات
            const attempts = getExamAttempts();
            
            // عرض رسالة إذا كانت هناك محاولات سابقة لهذا الهاتف
            if (attempts.deviceAttempts >= 2) {
                codeError.textContent = "لقد استخدمت هذا الهاتف لأداء الامتحان مرتين بالفعل.";
                startExamBtn.disabled = true;
                studentCodeInput.disabled = true;
            }
        }

        // بدء الامتحان
        function startExam() {
            const code = studentCodeInput.value.trim();
            
            if (code.length !== 9) {
                codeError.textContent = 'الكود يجب أن يتكون من 9 أرقام باللغة الإنجليزية';
                return;
            }
            
            // التحقق مما إذا كان الكود قد استخدم من قبل على هذا الهاتف
            if (isCodeAlreadyUsed(code)) {
                codeError.textContent = 'هذا الكود تم استخدامه بالفعل على هذا الهاتف';
                return;
            }
            
            // تسجيل محاولة جديدة
            registerNewAttempt(code);
            
            // حفظ كود الطالب
            examState.studentCode = code;
            examState.startTime = new Date();
            
            // إخفاء قسم الكود وعرض قسم الامتحان
            codeSection.classList.add('hidden');
            examSection.classList.remove('hidden');
            
            // تحميل الأسئلة
            loadQuestions();
        }

        // تحميل الأسئلة
        function loadQuestions() {
            questionsContainer.innerHTML = '';
            
            examData.questions.forEach((q, index) => {
                const questionElement = document.createElement('div');
                questionElement.className = 'question';
                
                let optionsHTML = '';
                q.options.forEach((option, optIndex) => {
                    optionsHTML += `
                        <div class="option" data-question="${index}" data-option="${optIndex}">
                            ${option}
                        </div>
                    `;
                });
                
                questionElement.innerHTML = `
                    <div class="question-number">س ${index + 1}: ${q.question}</div>
                    <div class="options">${optionsHTML}</div>
                `;
                
                questionsContainer.appendChild(questionElement);
            });
            
            // إضافة مستمعي الأحداث للخيارات
            document.querySelectorAll('.option').forEach(option => {
                option.addEventListener('click', function() {
                    const questionIndex = parseInt(this.getAttribute('data-question'));
                    const optionIndex = parseInt(this.getAttribute('data-option'));
                    
                    // إزالة التحديد من جميع خيارات هذا السؤال
                    document.querySelectorAll(`.option[data-question="${questionIndex}"]`).forEach(opt => {
                        opt.classList.remove('selected');
                    });
                    
                    // تحديد الخيار المختار
                    this.classList.add('selected');
                    
                    // حفظ الإجابة
                    examState.answers[questionIndex] = optionIndex;
                });
            });
        }

        // إنهاء الامتحان وتصحيحه
        function submitExam() {
            // التحقق من أن جميع الأسئلة تمت الإجابة عليها
            const unansweredQuestions = examState.answers.filter(answer => answer === null).length;
            
            if (unansweredQuestions > 0) {
                if (!confirm(`لم تقم بالإجابة على ${unansweredQuestions} سؤالاً. هل تريد إنهاء الامتحان مع ذلك؟`)) {
                    return;
                }
            }
            
            // حساب النتيجة
            let score = 0;
            const mistakes = [];
            
            examData.questions.forEach((q, index) => {
                if (examState.answers[index] === q.correctAnswer) {
                    score++;
                } else if (examState.answers[index] !== null) {
                    mistakes.push({
                        question: q.question,
                        studentAnswer: q.options[examState.answers[index]],
                        correctAnswer: q.options[q.correctAnswer]
                    });
                } else {
                    mistakes.push({
                        question: q.question,
                        studentAnswer: "لم يتم الإجابة",
                        correctAnswer: q.options[q.correctAnswer]
                    });
                }
            });
            
            // عرض النتيجة
            showResults(score, mistakes);
            
            // تحديث حالة الامتحان
            examState.examCompleted = true;
            
            // إخفاء قسم الامتحان وعرض قسم النتائج
            examSection.classList.add('hidden');
            resultSection.classList.remove('hidden');
            
            // إضافة الامتحان إلى السجل
            addToExamHistory(score, mistakes.length);
        }

        // عرض النتائج
        function showResults(score, mistakes) {
            const percentage = (score / examData.questions.length) * 100;
            
            let resultHTML = `
                <div class="result">
                    <h2>نتيجة الامتحان</h2>
                    <p>الكود: ${examState.studentCode}</p>
                    <div class="score">${score}/${examData.questions.length} (${percentage.toFixed(1)}%)</div>
                    <p>تم إنهاء الامتحان بنجاح!</p>
                </div>
            `;
            
            if (mistakes.length > 0) {
                let mistakesHTML = '<div class="mistakes"><h3>الأخطاء:</h3>';
                
                mistakes.forEach((mistake, index) => {
                    mistakesHTML += `
                        <div class="mistake-item">
                            <p><strong>س ${index + 1}:</strong> ${mistake.question}</p>
                            <p>إجابتك: <span class="wrong-answer">${mistake.studentAnswer}</span></p>
                            <p>الإجابة الصحيحة: <span class="correct-answer">${mistake.correctAnswer}</span></p>
                        </div>
                    `;
                });
                
                mistakesHTML += '</div>';
                resultHTML += mistakesHTML;
            }
            
            resultContent.innerHTML = resultHTML;
        }

        // تحديث المؤقت
        function updateTimer() {
            const now = new Date();
            const hours = now.getHours().toString().padStart(2, '0');
            const minutes = now.getMinutes().toString().padStart(2, '0');
            const seconds = now.getSeconds().toString().padStart(2, '0');
            
            timerElement.textContent = `${hours}:${minutes}:${seconds}`;
            
            // التحقق إذا كان الوقت بعد منتصف الليل
            if (now.getHours() >= 0 && now.getHours() < 6) {
                if (!examState.examCompleted) {
                    alert("انتهى وقت الامتحان (لا يفتح بعد الساعة 12 منتصف الليل)");
                    window.location.reload();
                }
            }
        }

        // ===== نظام التخزين المحلي المتقدم =====
        
        // إنشاء مفتاح جهاز فريد مع رمز مميز
        function generateDeviceKey() {
            // استخدام مزيج من خصائص المتصفح مع رمز عشوائي
            const userAgent = navigator.userAgent;
            const language = navigator.language;
            const timezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
            const randomToken = Math.random().toString(36).substring(2, 15);
            
            // إنشاء مفتاح فريد باستخدام hash بسيط
            const combinedString = `${userAgent}-${language}-${timezone}-${randomToken}`;
            
            // استخدام دالة hash بسيطة
            let hash = 0;
            for (let i = 0; i < combinedString.length; i++) {
                const char = combinedString.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash; // تحويل إلى 32bit integer
            }
            
            // إضافة بادئة مميزة
            return `NGS-${Math.abs(hash).toString(36).toUpperCase()}-${Date.now().toString(36).toUpperCase()}`;
        }

        // الحصول على سجل المحاولات
        function getExamAttempts() {
            const deviceKey = generateDeviceKey();
            const storedData = localStorage.getItem('NGS_Exam_Device_Records');
            
            if (!storedData) {
                return {
                    deviceKey: deviceKey,
                    deviceAttempts: 0,
                    usedCodes: []
                };
            }
            
            try {
                const parsedData = JSON.parse(storedData);
                
                // إذا كان مفتاح الجهاز مختلفًا، نبدأ سجلاً جديدًا
                if (parsedData.deviceKey !== deviceKey) {
                    return {
                        deviceKey: deviceKey,
                        deviceAttempts: 0,
                        usedCodes: []
                    };
                }
                
                return parsedData;
            } catch (e) {
                return {
                    deviceKey: deviceKey,
                    deviceAttempts: 0,
                    usedCodes: []
                };
            }
        }

        // التحقق مما إذا كان الكود مستخدمًا من قبل
        function isCodeAlreadyUsed(code) {
            const attempts = getExamAttempts();
            return attempts.usedCodes.includes(code);
        }

        // تسجيل محاولة جديدة
        function registerNewAttempt(code) {
            const attempts = getExamAttempts();
            
            // زيادة عدد محاولات الجهاز
            attempts.deviceAttempts += 1;
            
            // إضافة الكود إلى القائمة
            if (!attempts.usedCodes.includes(code)) {
                attempts.usedCodes.push(code);
            }
            
            // حفظ البيانات
            localStorage.setItem('NGS_Exam_Device_Records', JSON.stringify(attempts));
            
            // إنشاء سجل منفصل لهذا الكود مع رمز مميز
            const codeRecord = {
                code: code,
                deviceKey: attempts.deviceKey,
                examDate: new Date().toISOString(),
                examTitle: examData.title,
                // إضافة رمز عشوائي مميز للتسجيل
                recordToken: `EXAM-${Date.now()}-${Math.random().toString(36).substring(2, 9).toUpperCase()}`
            };
            
            // حفظ سجل الكود بشكل منفصل
            localStorage.setItem(`NGS_Exam_Code_${code}`, JSON.stringify(codeRecord));
        }

        // إضافة إلى سجل الامتحانات
        function addToExamHistory(score, mistakesCount) {
            const examHistory = {
                code: examState.studentCode,
                score: score,
                totalQuestions: examData.questions.length,
                mistakes: mistakesCount,
                date: new Date().toISOString(),
                examTitle: examData.title
            };
            
            // حفظ في سجل منفصل للنتائج
            localStorage.setItem(`NGS_Exam_Result_${examState.studentCode}`, JSON.stringify(examHistory));
        }
    </script>
</body>
</html>