<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø§Ù…ØªØ­Ø§Ù† Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ© - Ù…Ø¯Ø±Ø³Ø© Ø§Ù„Ø¬ÙŠÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ø§Ù„Ø®Ø§ØµØ©</title>
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, query, where } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";
        
        const firebaseConfig = {
            apiKey: "AIzaSyBPgtF_GqT95QkMwwoJMGiZWFPjHFdA_N0",
            authDomain: "manassa-oloom.firebaseapp.com",
            projectId: "manassa-oloom",
            storageBucket: "manassa-oloom.firebasestorage.app",
            messagingSenderId: "475047988456",
            appId: "1:475047988456:web:ab25a9b01b5c77483b0d5d",
            measurementId: "G-F0N011WQB9"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        window.firebaseApp = app;
        window.db = db;
        window.firestore = { collection, addDoc, getDocs, query, where };
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #1a237e 0%, #4a148c 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }
        
        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            overflow: hidden;
            display: none;
        }
        
        .header {
            background: linear-gradient(135deg, #0d47a1 0%, #311b92 100%);
            color: white;
            padding: 25px;
            text-align: center;
            border-bottom: 5px solid #ff9800;
        }
        
        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
            font-weight: bold;
        }
        
        .header h2 {
            font-size: 20px;
            color: #ffcc80;
            font-weight: normal;
        }
        
        .content {
            padding: 30px;
        }
        
        .form-section {
            margin-bottom: 30px;
            padding: 25px;
            background: #f5f5f5;
            border-radius: 10px;
            border-right: 5px solid #2196f3;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #1a237e;
            font-size: 16px;
        }
        
        input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border 0.3s;
        }
        
        input:focus {
            border-color: #2196f3;
            outline: none;
        }
        
        .error {
            color: #f44336;
            font-size: 14px;
            margin-top: 5px;
            display: none;
        }
        
        .btn {
            background: linear-gradient(135deg, #2196f3 0%, #0d47a1 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.3s, box-shadow 0.3s;
            display: inline-block;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(33, 150, 243, 0.4);
        }
        
        .btn:disabled {
            background: #cccccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);
        }
        
        .timer {
            background: #ff5722;
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 18px;
            font-weight: bold;
            text-align: center;
            margin-bottom: 20px;
            display: inline-block;
        }
        
        .question {
            background: white;
            border: 2px solid #e3f2fd;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            transition: border 0.3s;
        }
        
        .question:hover {
            border-color: #2196f3;
        }
        
        .question-number {
            display: inline-block;
            background: #2196f3;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            text-align: center;
            line-height: 30px;
            margin-bottom: 15px;
            font-weight: bold;
        }
        
        .question-text {
            font-size: 18px;
            margin-bottom: 15px;
            color: #1a237e;
            font-weight: 600;
        }
        
        .options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        @media (max-width: 768px) {
            .options {
                grid-template-columns: 1fr;
            }
        }
        
        .option {
            background: #f5f5f5;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .option:hover {
            background: #e3f2fd;
            border-color: #2196f3;
        }
        
        .option.selected {
            background: #bbdefb;
            border-color: #2196f3;
            color: #0d47a1;
        }
        
        .option.correct {
            background: #c8e6c9;
            border-color: #4caf50;
            color: #2e7d32;
        }
        
        .option.incorrect {
            background: #ffcdd2;
            border-color: #f44336;
            color: #c62828;
        }
        
        .result-section {
            text-align: center;
            padding: 30px;
        }
        
        .result-box {
            background: linear-gradient(135deg, #4caf50 0%, #2e7d32 100%);
            color: white;
            padding: 40px;
            border-radius: 15px;
            margin-bottom: 30px;
        }
        
        .result-score {
            font-size: 48px;
            font-weight: bold;
            margin: 20px 0;
        }
        
        .result-grade {
            font-size: 24px;
            margin-bottom: 20px;
        }
        
        .review-section {
            text-align: right;
            margin-top: 30px;
        }
        
        .review-question {
            background: white;
            border: 2px solid #e3f2fd;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .review-answer {
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
            font-weight: bold;
        }
        
        .correct-answer {
            background: #e8f5e9;
            color: #2e7d32;
            border: 1px solid #4caf50;
        }
        
        .user-answer {
            background: #fff3e0;
            color: #ef6c00;
            border: 1px solid #ff9800;
        }
        
        .login-container {
            max-width: 500px;
            margin: 50px auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }
        
        .message {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
            font-weight: bold;
            display: none;
        }
        
        .success {
            background: #e8f5e9;
            color: #2e7d32;
            border: 1px solid #4caf50;
        }
        
        .error-message {
            background: #ffebee;
            color: #c62828;
            border: 1px solid #f44336;
        }
        
        .warning {
            background: #fff3e0;
            color: #ef6c00;
            border: 1px solid #ff9800;
        }
        
        .grade-info {
            font-size: 14px;
            color: #666;
            margin-top: 5px;
        }
        
        .already-taken {
            text-align: center;
            padding: 40px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            margin: 50px auto;
            max-width: 600px;
            display: none;
        }
    </style>
</head>
<body>
    <!-- Login Section -->
    <div id="loginContainer" class="login-container">
        <div class="header">
            <h1>Ø§Ù…ØªØ­Ø§Ù† Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©</h1>
            <h2>Ù…Ø¯Ø±Ø³Ø© Ø§Ù„Ø¬ÙŠÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ø§Ù„Ø®Ø§ØµØ© - Ø§Ù„ØµÙ Ø§Ù„Ø³Ø§Ø¯Ø³ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ</h2>
        </div>
        <div class="content">
            <div id="message" class="message"></div>
            
            <div class="form-section">
                <div class="form-group">
                    <label for="studentName">Ø§Ù„Ø§Ø³Ù… Ø¨Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©:</label>
                    <input type="text" id="studentName" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ Ø¨Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©" dir="rtl">
                    <div id="nameError" class="error">Ø§Ù„Ø§Ø³Ù… Ù…Ø·Ù„ÙˆØ¨ ÙˆÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø¨Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</div>
                </div>
                
                <div class="form-group">
                    <label for="studentCode">Ø§Ù„ÙƒÙˆØ¯ (9 Ø®Ø§Ù†Ø§Øª Ø¨Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©):</label>
                    <input type="text" id="studentCode" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ù…ÙƒÙˆÙ† Ù…Ù† 9 Ø®Ø§Ù†Ø§Øª" dir="ltr" maxlength="9">
                    <div id="codeError" class="error">Ø§Ù„ÙƒÙˆØ¯ Ù…Ø·Ù„ÙˆØ¨ ÙˆÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† 9 Ø£Ø±Ù‚Ø§Ù…</div>
                    <div class="grade-info">Ø§Ù„ÙƒÙˆØ¯ Ù…ÙƒÙˆÙ† Ù…Ù† 9 Ø£Ø±Ù‚Ø§Ù…ØŒ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø±Ø§Ø¨Ø¹ Ù…Ù† Ø§Ù„ÙŠÙ…ÙŠÙ† ÙŠØ­Ø¯Ø¯ Ø§Ù„ØµÙ</div>
                </div>
                
                <button id="startExamBtn" class="btn" onclick="startExam()">Ø¨Ø¯Ø¡ Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†</button>
            </div>
        </div>
    </div>

    <!-- Exam Container -->
    <div id="examContainer" class="container">
        <div class="header">
            <h1>Ø§Ù…ØªØ­Ø§Ù† Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©</h1>
            <h2>Ù…Ø¯Ø±Ø³Ø© Ø§Ù„Ø¬ÙŠÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ø§Ù„Ø®Ø§ØµØ© - Ø§Ù„ØµÙ Ø§Ù„Ø³Ø§Ø¯Ø³ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ</h2>
            <div class="timer" id="timer">15:00</div>
        </div>
        
        <div class="content">
            <div id="questionsSection">
                <!-- Questions will be inserted here dynamically -->
            </div>
            
            <div style="text-align: center; margin-top: 30px;">
                <button id="submitBtn" class="btn" onclick="submitExam()" disabled>Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†</button>
            </div>
        </div>
    </div>

    <!-- Results Container -->
    <div id="resultsContainer" class="container" style="display: none;">
        <div class="header">
            <h1>Ù†ØªÙŠØ¬Ø© Ø§Ù…ØªØ­Ø§Ù† Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©</h1>
            <h2>Ù…Ø¯Ø±Ø³Ø© Ø§Ù„Ø¬ÙŠÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ø§Ù„Ø®Ø§ØµØ©</h2>
        </div>
        
        <div class="content">
            <div class="result-section">
                <div class="result-box">
                    <h3>Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©</h3>
                    <div class="result-score" id="finalScore">0/10</div>
                    <div class="result-grade" id="finalGrade">...</div>
                    <p id="studentInfo">Ø§Ù„Ø·Ø§Ù„Ø¨: ... | Ø§Ù„ÙƒÙˆØ¯: ...</p>
                </div>
                
                <div id="reviewSection" class="review-section">
                    <!-- Review will be inserted here dynamically -->
                </div>
                
                <button class="btn btn-secondary" onclick="window.location.reload()">Ø§Ù„Ø±Ø¬ÙˆØ¹ Ù„Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
            </div>
        </div>
    </div>

    <!-- Already Taken Container -->
    <div id="alreadyTakenContainer" class="already-taken">
        <div class="header" style="border-radius: 0;">
            <h1>Ø§Ù…ØªØ­Ø§Ù† Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©</h1>
            <h2>Ù…Ø¯Ø±Ø³Ø© Ø§Ù„Ø¬ÙŠÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ø§Ù„Ø®Ø§ØµØ©</h2>
        </div>
        <div style="padding: 40px;">
            <h3 style="color: #f44336; margin-bottom: 20px;">âš ï¸ Ù„Ù‚Ø¯ Ø£Ø¯ÙŠØª Ø§Ù„Ø§Ù…ØªØ­Ø§Ù† Ù…Ø³Ø¨Ù‚Ø§Ù‹</h3>
            <p style="margin-bottom: 15px; font-size: 18px;">Ø¹Ø°Ø±Ø§Ù‹ <span id="takenName"></span>ØŒ</p>
            <p style="margin-bottom: 20px;">Ù„Ù‚Ø¯ Ù‚Ù…Øª Ø¨Ø£Ø¯Ø§Ø¡ Ø§Ù„Ø§Ù…ØªØ­Ø§Ù† Ù…Ø³Ø¨Ù‚Ø§Ù‹ Ø¨ØªØ§Ø±ÙŠØ®: <span id="takenDate"></span></p>
            <p style="margin-bottom: 30px;">Ù†ØªÙŠØ¬ØªÙƒ: <span id="takenScore"></span></p>
            <button class="btn" onclick="window.location.reload()">Ø­Ø³Ù†Ø§Ù‹</button>
        </div>
    </div>

    <script>
        // Exam Data with correct answers and explanations for Grade 6
        const examData = {
            questions: [
                {
                    id: 1,
                    question: "They ...... able to speak English.",
                    options: [
                        { id: "a", text: "is" },
                        { id: "b", text: "are" },
                        { id: "c", text: "am" },
                        { id: "d", text: "be" }
                    ],
                    correctAnswer: "b",
                    explanation: "Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø© Ù‡ÙŠ 'are' Ù„Ø£Ù† Ø§Ù„ÙØ§Ø¹Ù„ 'They' (Ù‡Ù…) ÙŠØ³ØªØ®Ø¯Ù… Ù…Ø¹Ù‡ 'are' ÙÙŠ Ø§Ù„Ù…Ø¶Ø§Ø±Ø¹ Ø§Ù„Ø¨Ø³ÙŠØ· Ù…Ø¹ 'able to'."
                },
                {
                    id: 2,
                    question: "He is able ...... fast.",
                    options: [
                        { id: "a", text: "run" },
                        { id: "b", text: "to run" },
                        { id: "c", text: "running" },
                        { id: "d", text: "runs" }
                    ],
                    correctAnswer: "b",
                    explanation: "Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø© Ù‡ÙŠ 'to run' Ù„Ø£Ù† 'able to' ÙŠØªØ¨Ø¹Ù‡Ø§ Ø§Ù„Ù…ØµØ¯Ø± Ù…Ø¹ 'to' (to + Ø§Ù„ÙØ¹Ù„ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ)."
                },
                {
                    id: 3,
                    question: "I ...... able to swim.",
                    options: [
                        { id: "a", text: "am not" },
                        { id: "b", text: "is not" },
                        { id: "c", text: "are not" },
                        { id: "d", text: "do not" }
                    ],
                    correctAnswer: "a",
                    explanation: "Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø© Ù‡ÙŠ 'am not' Ù„Ø£Ù† Ø§Ù„ÙØ§Ø¹Ù„ 'I' (Ø£Ù†Ø§) ÙŠØ³ØªØ®Ø¯Ù… Ù…Ø¹Ù‡ 'am' ÙÙŠ ØµÙŠØºØ© Ø§Ù„Ù†ÙÙŠ Ù…Ø¹ 'able to'."
                },
                {
                    id: 4,
                    question: "She is able to ...... the drums.",
                    options: [
                        { id: "a", text: "plays" },
                        { id: "b", text: "play" },
                        { id: "c", text: "playing" },
                        { id: "d", text: "played" }
                    ],
                    correctAnswer: "b",
                    explanation: "Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø© Ù‡ÙŠ 'play' Ù„Ø£Ù† Ø¨Ø¹Ø¯ 'to' ÙÙŠ 'able to' ÙŠØ£ØªÙŠ Ø§Ù„ÙØ¹Ù„ ÙÙŠ Ø§Ù„Ù…ØµØ¯Ø± Ø¨Ø¯ÙˆÙ† Ø¥Ø¶Ø§ÙØ§Øª."
                },
                {
                    id: 5,
                    question: "Is he ...... to play handball?",
                    options: [
                        { id: "a", text: "can" },
                        { id: "b", text: "able" },
                        { id: "c", text: "could" },
                        { id: "d", text: "ability" }
                    ],
                    correctAnswer: "b",
                    explanation: "Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø© Ù‡ÙŠ 'able' Ù„Ø£Ù† 'able to' Ù‡ÙŠ Ø§Ù„ØªØ¹Ø¨ÙŠØ± Ø§Ù„ØµØ­ÙŠØ­ Ù„Ù„Ø³Ø¤Ø§Ù„ Ø¹Ù† Ø§Ù„Ù‚Ø¯Ø±Ø©."
                },
                {
                    id: 6,
                    question: "He ______ study hard for the exam.",
                    options: [
                        { id: "a", text: "must" },
                        { id: "b", text: "mustn't" },
                        { id: "c", text: "should" },
                        { id: "d", text: "shouldn't" }
                    ],
                    correctAnswer: "a",
                    explanation: "Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø© Ù‡ÙŠ 'must' Ù„Ø£Ù† Ø§Ù„Ø¬Ù…Ù„Ø© ØªØªØ·Ù„Ø¨ Ø§Ù„ØªØ¹Ø¨ÙŠØ± Ø¹Ù† Ø§Ù„Ø§Ù„ØªØ²Ø§Ù… ÙˆØ§Ù„Ø¶Ø±ÙˆØ±Ø© Ù„Ù„Ø¯Ø±Ø§Ø³Ø© Ù„Ù„Ø§Ù…ØªØ­Ø§Ù†."
                },
                {
                    id: 7,
                    question: "We ______ waste water or electricity.",
                    options: [
                        { id: "a", text: "must" },
                        { id: "b", text: "mustn't" },
                        { id: "c", text: "should" },
                        { id: "d", text: "can" }
                    ],
                    correctAnswer: "b",
                    explanation: "Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø© Ù‡ÙŠ 'mustn't' Ù„Ø£Ù†Ù‡Ø§ ØªØ¹Ø¨Ø± Ø¹Ù† Ø§Ù„Ù†Ù‡ÙŠ ÙˆØ§Ù„Ù…Ù†Ø¹ Ù…Ù† Ø¥Ù‡Ø¯Ø§Ø± Ø§Ù„Ù…Ø§Ø¡ Ø£Ùˆ Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¡."
                },
                {
                    id: 8,
                    question: "We must ______ trees to help the environment.",
                    options: [
                        { id: "a", text: "planting" },
                        { id: "b", text: "plant" },
                        { id: "c", text: "to plant" },
                        { id: "d", text: "plants" }
                    ],
                    correctAnswer: "b",
                    explanation: "Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø© Ù‡ÙŠ 'plant' Ù„Ø£Ù† Ø¨Ø¹Ø¯ 'must' ÙŠØ£ØªÙŠ Ø§Ù„ÙØ¹Ù„ ÙÙŠ Ø§Ù„Ù…ØµØ¯Ø± Ø¨Ø¯ÙˆÙ† 'to'."
                },
                {
                    id: 9,
                    question: "Marwan must ______ to catch the train.",
                    options: [
                        { id: "a", text: "to hurry" },
                        { id: "b", text: "hurrying" },
                        { id: "c", text: "hurry" },
                        { id: "d", text: "hurries" }
                    ],
                    correctAnswer: "c",
                    explanation: "Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø© Ù‡ÙŠ 'hurry' Ù„Ø£Ù† Ø¨Ø¹Ø¯ 'must' ÙŠØ£ØªÙŠ Ø§Ù„ÙØ¹Ù„ ÙÙŠ Ø§Ù„Ù…ØµØ¯Ø± Ø¨Ø¯ÙˆÙ† 'to'."
                },
                {
                    id: 10,
                    question: "We ______ be unkind to others.",
                    options: [
                        { id: "a", text: "must" },
                        { id: "b", text: "mustn't" },
                        { id: "c", text: "should" },
                        { id: "d", text: "can" }
                    ],
                    correctAnswer: "b",
                    explanation: "Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø© Ù‡ÙŠ 'mustn't' Ù„Ø£Ù†Ù‡Ø§ ØªØ¹Ø¨Ø± Ø¹Ù† Ø§Ù„Ù†Ù‡ÙŠ ÙˆØ§Ù„Ù…Ù†Ø¹ Ù…Ù† Ø£Ù† Ù†ÙƒÙˆÙ† ØºÙŠØ± Ù„Ø·ÙØ§Ø¡ Ù…Ø¹ Ø§Ù„Ø¢Ø®Ø±ÙŠÙ†."
                }
            ],
            timeLimit: 15 * 60,
            passingGrade: 5
        };

        let studentData = {
            name: "",
            code: "",
            grade: "",
            startTime: null,
            answers: {},
            score: 0
        };

        let timerInterval;
        let timeLeft;

        function showMessage(text, type) {
            const messageDiv = document.getElementById('message');
            messageDiv.textContent = text;
            messageDiv.className = 'message ' + type;
            messageDiv.style.display = 'block';
            
            setTimeout(() => {
                messageDiv.style.display = 'none';
            }, 5000);
        }

        function getGradeFromCode(code) {
            if (code.length !== 9) return null;
            
            // Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø±Ø§Ø¨Ø¹ Ù…Ù† Ø§Ù„ÙŠÙ…ÙŠÙ† (Ø§Ù„Ø±Ù‚Ù… ÙÙŠ Ø§Ù„Ù…Ø±ÙƒØ² Ø§Ù„Ø³Ø§Ø¯Ø³ Ù…Ù† Ø§Ù„ÙŠØ³Ø§Ø±)
            const fourthFromRight = code[5]; // Ù„Ø£Ù† Ø§Ù„ÙÙ‡Ø±Ø³ ÙŠØ¨Ø¯Ø£ Ù…Ù† 0
            
            const grades = {
                '4': 'Ø§Ù„ØµÙ Ø§Ù„Ø±Ø§Ø¨Ø¹ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ',
                '5': 'Ø§Ù„ØµÙ Ø§Ù„Ø®Ø§Ù…Ø³ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ',
                '6': 'Ø§Ù„ØµÙ Ø§Ù„Ø³Ø§Ø¯Ø³ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ',
                '7': 'Ø§Ù„ØµÙ Ø§Ù„Ø£ÙˆÙ„ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ',
                '8': 'Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù†ÙŠ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ'
            };
            
            return grades[fourthFromRight] || null;
        }

        function isValidArabicName(name) {
            if (!name || name.trim().length < 2) return false;
            
            const arabicRegex = /^[\u0600-\u06FF\u0750-\u077F\u08A0-\u08FF\s]+$/;
            return arabicRegex.test(name.trim());
        }

        function isValidStudentCode(code) {
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ø§Ù„ÙƒÙˆØ¯ ÙŠØªÙƒÙˆÙ† ÙÙ‚Ø· Ù…Ù† 9 Ø£Ø±Ù‚Ø§Ù…
            const codeRegex = /^\d{9}$/;
            return codeRegex.test(code);
        }

        async function checkIfTaken(studentCode) {
            try {
                const db = window.db;
                const { collection, getDocs, query, where } = window.firestore;
                
                const examResultsRef = collection(db, 'examResults');
                const q = query(examResultsRef, where('studentCode', '==', studentCode));
                const querySnapshot = await getDocs(q);
                
                return !querySnapshot.empty;
            } catch (error) {
                console.error('Error checking exam status:', error);
                return false;
            }
        }

        async function getExistingResult(studentCode) {
            try {
                const db = window.db;
                const { collection, getDocs, query, where } = window.firestore;
                
                const examResultsRef = collection(db, 'examResults');
                const q = query(examResultsRef, where('studentCode', '==', studentCode));
                const querySnapshot = await getDocs(q);
                
                if (!querySnapshot.empty) {
                    const doc = querySnapshot.docs[0];
                    const data = doc.data();
                    if (data.examDate) {
                        const date = new Date(data.examDate);
                        data.formattedDate = date.toLocaleDateString('ar-EG', {
                            year: 'numeric',
                            month: 'long',
                            day: 'numeric',
                            hour: '2-digit',
                            minute: '2-digit'
                        });
                    }
                    return data;
                }
                return null;
            } catch (error) {
                console.error('Error getting existing result:', error);
                return null;
            }
        }

        async function startExam() {
            const name = document.getElementById('studentName').value.trim();
            const code = document.getElementById('studentCode').value.trim();
            
            document.getElementById('nameError').style.display = 'none';
            document.getElementById('codeError').style.display = 'none';
            
            let hasError = false;
            
            if (!isValidArabicName(name)) {
                document.getElementById('nameError').style.display = 'block';
                hasError = true;
            }
            
            if (!isValidStudentCode(code)) {
                document.getElementById('codeError').textContent = 'Ø§Ù„ÙƒÙˆØ¯ Ù…Ø·Ù„ÙˆØ¨ ÙˆÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† 9 Ø£Ø±Ù‚Ø§Ù… ÙÙ‚Ø·';
                document.getElementById('codeError').style.display = 'block';
                hasError = true;
            }
            
            if (hasError) return;
            
            const alreadyTaken = await checkIfTaken(code);
            if (alreadyTaken) {
                const existingResult = await getExistingResult(code);
                document.getElementById('takenName').textContent = name;
                document.getElementById('takenDate').textContent = existingResult?.formattedDate || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';
                document.getElementById('takenScore').textContent = existingResult?.score + '/10';
                document.getElementById('loginContainer').style.display = 'none';
                document.getElementById('alreadyTakenContainer').style.display = 'block';
                return;
            }
            
            const grade = getGradeFromCode(code);
            if (!grade) {
                document.getElementById('codeError').textContent = 'Ø§Ù„ÙƒÙˆØ¯ ØºÙŠØ± ØµØ§Ù„Ø­ØŒ ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø±Ø§Ø¨Ø¹ Ù…Ù† Ø§Ù„ÙŠÙ…ÙŠÙ†';
                document.getElementById('codeError').style.display = 'block';
                return;
            }
            
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ø§Ù„Ø·Ø§Ù„Ø¨ ÙÙŠ Ø§Ù„ØµÙ Ø§Ù„Ø³Ø§Ø¯Ø³ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ
            if (!grade.includes('Ø§Ù„Ø³Ø§Ø¯Ø³ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ')) {
                showMessage('Ù‡Ø°Ø§ Ø§Ù„Ø§Ù…ØªØ­Ø§Ù† Ù…Ø®ØµØµ Ù„Ù„ØµÙ Ø§Ù„Ø³Ø§Ø¯Ø³ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ ÙÙ‚Ø·', 'warning');
                return;
            }
            
            studentData.name = name;
            studentData.code = code;
            studentData.grade = grade;
            studentData.startTime = new Date();
            
            document.getElementById('loginContainer').style.display = 'none';
            document.getElementById('examContainer').style.display = 'block';
            
            initializeExam();
        }

        function initializeExam() {
            const questionsSection = document.getElementById('questionsSection');
            questionsSection.innerHTML = '';
            
            examData.questions.forEach((q, index) => {
                const questionDiv = document.createElement('div');
                questionDiv.className = 'question';
                questionDiv.innerHTML = `
                    <div class="question-number">${index + 1}</div>
                    <div class="question-text">${q.question}</div>
                    <div class="options">
                        ${q.options.map(opt => `
                            <div class="option" data-question="${q.id}" data-option="${opt.id}" onclick="selectAnswer(this)">
                                ${opt.id}) ${opt.text}
                            </div>
                        `).join('')}
                    </div>
                `;
                questionsSection.appendChild(questionDiv);
            });
            
            timeLeft = examData.timeLimit;
            updateTimerDisplay();
            
            timerInterval = setInterval(() => {
                timeLeft--;
                updateTimerDisplay();
                
                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    submitExam();
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            const minutes = Math.floor(timeLeft / 60);
            const seconds = timeLeft % 60;
            document.getElementById('timer').textContent = 
                `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            
            const answeredCount = Object.keys(studentData.answers).length;
            document.getElementById('submitBtn').disabled = answeredCount !== examData.questions.length;
            
            if (timeLeft <= 60) {
                document.getElementById('timer').style.background = '#f44336';
            } else if (timeLeft <= 300) {
                document.getElementById('timer').style.background = '#ff9800';
            }
        }

        function selectAnswer(element) {
            const questionId = element.getAttribute('data-question');
            const optionId = element.getAttribute('data-option');
            
            const options = document.querySelectorAll(`[data-question="${questionId}"]`);
            options.forEach(opt => opt.classList.remove('selected'));
            
            element.classList.add('selected');
            studentData.answers[questionId] = optionId;
            
            const answeredCount = Object.keys(studentData.answers).length;
            document.getElementById('submitBtn').disabled = answeredCount !== examData.questions.length;
        }

        function calculateScore() {
            let score = 0;
            examData.questions.forEach(q => {
                if (studentData.answers[q.id] === q.correctAnswer) {
                    score++;
                }
            });
            return score;
        }

        function getGradeMessage(score) {
            if (score >= 9) return "Ù…Ù…ØªØ§Ø²! ğŸ‰";
            if (score >= 7) return "Ø¬ÙŠØ¯ Ø¬Ø¯Ø§Ù‹! ğŸ‘";
            if (score >= 5) return "Ø¬ÙŠØ¯ ğŸ‘Œ";
            return "ÙŠØ­ØªØ§Ø¬ ØªØ­Ø³ÙŠÙ† ğŸ’ª";
        }

        async function saveResultToFirebase() {
            try {
                const db = window.db;
                const { collection, addDoc } = window.firestore;
                
                const examResult = {
                    studentName: studentData.name,
                    studentCode: studentData.code,
                    studentGrade: studentData.grade,
                    score: studentData.score,
                    totalQuestions: examData.questions.length,
                    answers: studentData.answers,
                    examDate: new Date().toISOString(),
                    duration: examData.timeLimit - timeLeft,
                    timestamp: Date.now(),
                    examType: "Ø§Ù„ØµÙ Ø§Ù„Ø³Ø§Ø¯Ø³ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ - Grammar (able to & must)"
                };
                
                const examResultsRef = collection(db, 'examResults');
                await addDoc(examResultsRef, examResult);
                
                localStorage.setItem(`exam_result_${studentData.code}`, JSON.stringify(examResult));
                
                return true;
            } catch (error) {
                console.error('Error saving to Firebase:', error);
                try {
                    const examResult = {
                        studentName: studentData.name,
                        studentCode: studentData.code,
                        studentGrade: studentData.grade,
                        score: studentData.score,
                        totalQuestions: examData.questions.length,
                        answers: studentData.answers,
                        examDate: new Date().toISOString(),
                        duration: examData.timeLimit - timeLeft,
                        timestamp: Date.now(),
                        examType: "Ø§Ù„ØµÙ Ø§Ù„Ø³Ø§Ø¯Ø³ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ - Grammar (able to & must)"
                    };
                    localStorage.setItem(`exam_result_${studentData.code}`, JSON.stringify(examResult));
                    return true;
                } catch (e) {
                    console.error('Error saving to local storage:', e);
                    return false;
                }
            }
        }

        async function submitExam() {
            clearInterval(timerInterval);
            studentData.score = calculateScore();
            
            const saved = await saveResultToFirebase();
            
            if (!saved) {
                showMessage('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù†ØªÙŠØ¬Ø© Ù…Ø­Ù„ÙŠØ§Ù‹ØŒ Ø³ÙŠØªÙ… Ù…Ø­Ø§ÙˆÙ„Ø© Ø±ÙØ¹Ù‡Ø§ Ù„Ù„Ø®Ø§Ø¯Ù… Ù„Ø§Ø­Ù‚Ø§Ù‹', 'warning');
            }
            
            showResults();
        }

        function showResults() {
            document.getElementById('examContainer').style.display = 'none';
            
            document.getElementById('finalScore').textContent = `${studentData.score}/${examData.questions.length}`;
            document.getElementById('finalGrade').textContent = getGradeMessage(studentData.score);
            document.getElementById('studentInfo').textContent = 
                `Ø§Ù„Ø·Ø§Ù„Ø¨: ${studentData.name} | Ø§Ù„ÙƒÙˆØ¯: ${studentData.code} | Ø§Ù„ØµÙ: ${studentData.grade}`;
            
            const reviewSection = document.getElementById('reviewSection');
            reviewSection.innerHTML = '<h3 style="margin-bottom: 20px; color: #1a237e;">Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø£Ø³Ø¦Ù„Ø© ÙˆØ§Ù„Ø£Ø¬ÙˆØ¨Ø©:</h3>';
            
            examData.questions.forEach((q, index) => {
                const userAnswer = studentData.answers[q.id];
                const isCorrect = userAnswer === q.correctAnswer;
                const userOption = q.options.find(opt => opt.id === userAnswer);
                const correctOption = q.options.find(opt => opt.id === q.correctAnswer);
                
                const reviewDiv = document.createElement('div');
                reviewDiv.className = 'review-question';
                reviewDiv.innerHTML = `
                    <div style="margin-bottom: 10px;">
                        <strong>Ø³ ${index + 1}:</strong> ${q.question}
                    </div>
                    <div class="review-answer user-answer" style="display: ${userAnswer ? 'block' : 'none'}">
                        Ø¥Ø¬Ø§Ø¨ØªÙƒ: ${userOption ? userOption.id + ') ' + userOption.text : 'Ù„Ù… ØªØ¬Ø¨'}
                        ${isCorrect ? ' âœ… ØµØ­ÙŠØ­Ø©' : ' âŒ Ø®Ø§Ø·Ø¦Ø©'}
                    </div>
                    <div class="review-answer correct-answer">
                        Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©: ${correctOption.id}) ${correctOption.text}
                    </div>
                    <div style="margin-top: 10px; padding: 10px; background: #f5f5f5; border-radius: 5px;">
                        <strong>Ø§Ù„ØªÙØ³ÙŠØ±:</strong> ${q.explanation}
                    </div>
                `;
                reviewSection.appendChild(reviewDiv);
            });
            
            document.getElementById('resultsContainer').style.display = 'block';
        }

        document.addEventListener('DOMContentLoaded', function() {
            const savedExam = localStorage.getItem('current_exam');
            if (savedExam) {
                try {
                    const exam = JSON.parse(savedExam);
                    if (exam.code && exam.name) {
                        document.getElementById('studentName').value = exam.name;
                        document.getElementById('studentCode').value = exam.code;
                    }
                } catch (e) {
                    // ØªØ¬Ø§Ù‡Ù„ Ø§Ù„Ø®Ø·Ø£
                }
            }
            
            document.getElementById('studentName').addEventListener('input', function() {
                localStorage.setItem('current_exam', JSON.stringify({
                    name: this.value,
                    code: document.getElementById('studentCode').value
                }));
            });
            
            document.getElementById('studentCode').addEventListener('input', function() {
                localStorage.setItem('current_exam', JSON.stringify({
                    name: document.getElementById('studentName').value,
                    code: this.value
                }));
                
                if (this.value.length > 0 && !/^\d+$/.test(this.value)) {
                    document.getElementById('codeError').textContent = 'Ø§Ù„ÙƒÙˆØ¯ ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø£Ø±Ù‚Ø§Ù… ÙÙ‚Ø·';
                    document.getElementById('codeError').style.display = 'block';
                } else if (this.value.length > 0 && this.value.length !== 9) {
                    document.getElementById('codeError').textContent = 'Ø§Ù„ÙƒÙˆØ¯ ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† 9 Ø£Ø±Ù‚Ø§Ù…';
                    document.getElementById('codeError').style.display = 'block';
                } else {
                    document.getElementById('codeError').style.display = 'none';
                }
                
                if (this.value.length === 9 && /^\d{9}$/.test(this.value)) {
                    const grade = getGradeFromCode(this.value);
                    if (grade) {
                        const gradeInfo = document.querySelector('.grade-info');
                        gradeInfo.innerHTML = `Ø§Ù„ØµÙ: <strong>${grade}</strong>`;
                        gradeInfo.style.color = '#4caf50';
                        
                        // Ø¹Ø±Ø¶ ØªØ­Ø°ÙŠØ± Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„ÙƒÙˆØ¯ Ù„ÙŠØ³ Ù„Ù„ØµÙ Ø§Ù„Ø³Ø§Ø¯Ø³
                        if (!grade.includes('Ø§Ù„Ø³Ø§Ø¯Ø³ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ')) {
                            gradeInfo.innerHTML += `<br><span style="color: #ff5722;">Ù‡Ø°Ø§ Ø§Ù„ÙƒÙˆØ¯ Ù„Ù€ ${grade} ÙˆÙ„ÙŠØ³ Ù„Ù„ØµÙ Ø§Ù„Ø³Ø§Ø¯Ø³</span>`;
                        }
                    }
                }
            });
            
            document.getElementById('studentCode').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    startExam();
                }
            });
        });
    </script>
</body>
</html>