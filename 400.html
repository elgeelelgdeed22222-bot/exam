<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>امتحان الرياضيات - الصف الخامس الابتدائي</title>
    <style>
        * {
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            margin: 0;
            padding: 20px;
            background-color: #f5f9ff;
            color: #333;
            line-height: 1.6;
            font-size: 14px;
        }
        
        .header {
            text-align: center;
            background: linear-gradient(135deg, #1a5fb4, #2d7cd6);
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .header h1 {
            margin: 0;
            font-size: 22px;
        }
        
        .header h2 {
            margin: 10px 0 0 0;
            font-size: 18px;
            font-weight: normal;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
        }
        
        .card {
            background-color: white;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
            display: none;
        }
        
        .active {
            display: block;
        }
        
        .code-input {
            width: 100%;
            padding: 15px;
            font-size: 20px;
            text-align: center;
            border: 2px solid #ddd;
            border-radius: 8px;
            margin: 15px 0;
            letter-spacing: 5px;
            font-family: monospace;
        }
        
        .code-input:focus {
            border-color: #1a5fb4;
            outline: none;
        }
        
        .btn {
            background-color: #1a5fb4;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            width: 100%;
            margin-top: 10px;
            transition: background-color 0.3s;
        }
        
        .btn:hover {
            background-color: #155aa0;
        }
        
        .btn:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        
        .question {
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eee;
        }
        
        .question:last-child {
            border-bottom: none;
        }
        
        .question-number {
            font-weight: bold;
            color: #1a5fb4;
            margin-bottom: 8px;
            font-size: 16px;
        }
        
        .options {
            margin-top: 10px;
        }
        
        .option {
            margin-bottom: 10px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .option:hover {
            background-color: #f0f7ff;
            border-color: #a0c8ff;
        }
        
        .option.selected {
            background-color: #e1f0ff;
            border-color: #1a5fb4;
        }
        
        .option-label {
            display: inline-block;
            width: 25px;
            height: 25px;
            background-color: #1a5fb4;
            color: white;
            border-radius: 50%;
            text-align: center;
            line-height: 25px;
            margin-left: 8px;
            font-weight: bold;
        }
        
        .result {
            text-align: center;
            padding: 20px;
        }
        
        .grade {
            font-size: 28px;
            font-weight: bold;
            color: #1a5fb4;
            margin: 20px 0;
        }
        
        .mistakes {
            text-align: right;
            margin-top: 30px;
            font-size: 14px;
        }
        
        .mistake-item {
            background-color: #fff5f5;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 6px;
            border-right: 4px solid #e53e3e;
        }
        
        .correct-answer {
            color: #38a169;
            font-weight: bold;
        }
        
        .student-answer {
            color: #c53030;
            font-weight: bold;
        }
        
        .timer {
            text-align: center;
            font-size: 16px;
            color: #4a5568;
            margin: 15px 0;
            padding: 10px;
            background-color: #edf2f7;
            border-radius: 6px;
        }
        
        .error-message {
            background-color: #fed7d7;
            color: #c53030;
            padding: 12px;
            border-radius: 6px;
            margin: 15px 0;
            text-align: center;
            display: none;
        }
        
        .success-message {
            background-color: #c6f6d5;
            color: #22543d;
            padding: 12px;
            border-radius: 6px;
            margin: 15px 0;
            text-align: center;
            display: none;
        }
        
        .rules {
            background-color: #e6f7ff;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            font-size: 14px;
            border-right: 4px solid #1a5fb4;
        }
        
        .rules h3 {
            margin-top: 0;
            color: #1a5fb4;
        }
        
        @media (max-width: 480px) {
            body {
                padding: 10px;
                font-size: 13px;
            }
            
            .header h1 {
                font-size: 18px;
            }
            
            .header h2 {
                font-size: 16px;
            }
            
            .card {
                padding: 15px;
            }
            
            .code-input {
                font-size: 18px;
                padding: 12px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>مدرسة الجيل الجديد الخاصة</h1>
            <h2>امتحان الرياضيات للصف الخامس الابتدائي</h2>
        </div>
        
        <!-- شاشة إدخال الكود -->
        <div id="code-screen" class="card active">
            <div class="rules">
                <h3>تعليمات الدخول:</h3>
                <ul>
                    <li>أدخل الكود المكون من 9 أرقام إنجليزية فقط</li>
                    <li>يمكن لكل كود الدخول للامتحان مرة واحدة فقط</li>
                    <li>يمكن لكل هاتف دخول الامتحان مرتين فقط بكودين مختلفين</li>
                    <li>الامتحان متاح حتى الساعة 12 منتصف الليل فقط</li>
                    <li>بعد الانتهاء من الإجابة سيتم تصحيح الامتحان وعرض النتيجة</li>
                </ul>
            </div>
            
            <div id="time-error" class="error-message">
                لا يمكن الدخول للامتحان بعد الساعة 12 منتصف الليل. حاول مرة أخرى في اليوم التالي.
            </div>
            
            <div id="code-error" class="error-message">
                الكود الذي أدخلته غير صحيح أو تم استخدامه من قبل على هذا الهاتف.
            </div>
            
            <div id="phone-limit-error" class="error-message">
                لقد تجاوزت الحد المسموح به لدخول الامتحان من هذا الهاتف (مرتين فقط).
            </div>
            
            <div id="code-success" class="success-message">
                تم التحقق من الكود بنجاح! جاهز للبدء.
            </div>
            
            <div class="timer" id="current-time"></div>
            
            <label for="student-code">أدخل الكود المكون من 9 أرقام:</label>
            <input type="text" id="student-code" class="code-input" maxlength="9" placeholder="123456789" inputmode="numeric">
            <button id="start-exam" class="btn">بدء الامتحان</button>
        </div>
        
        <!-- شاشة الامتحان -->
        <div id="exam-screen" class="card">
            <div class="timer" id="exam-timer">الوقت المتبقي: <span id="time-left">30:00</span></div>
            
            <form id="exam-form">
                <!-- الأسئلة سيتم إضافتها ديناميكياً -->
            </form>
            
            <button id="submit-exam" class="btn">إنهاء الامتحان وتصحيح الإجابات</button>
        </div>
        
        <!-- شاشة النتيجة -->
        <div id="result-screen" class="card">
            <div class="result">
                <h2>نتيجة امتحان الرياضيات</h2>
                <div class="grade">الدرجة: <span id="final-grade">0</span>/10</div>
                <p>تم الانتهاء من تصحيح الامتحان</p>
                
                <div id="mistakes-container" class="mistakes">
                    <!-- الأخطاء ستظهر هنا -->
                </div>
                
                <button id="restart-btn" class="btn" style="background-color: #38a169; margin-top: 30px;">عودة للرئيسية</button>
            </div>
        </div>
    </div>

    <script>
        // بيانات الأسئلة والإجابات الصحيحة - تم تغيير الأرقام إلى الإنجليزية
        const examData = {
            title: "امتحان الرياضيات للصف الخامس الابتدائي",
            questions: [
                {
                    id: 1,
                    text: "1. الخطوة الأولى في إيجاد قيمة التعبير العددي 35 ÷ 7 + 5 - 2 هي..................",
                    options: [
                        "الضرب",
                        "القسمة", 
                        "الجمع",
                        "الطرح"
                    ],
                    correctAnswer: 1 // الفهرس 1 يعني الخيار الثاني (ب)
                },
                {
                    id: 2,
                    text: "2. العدد التالي مباشرة في النمط 5، 10، 20، 40، ... هو..............",
                    options: [
                        "80",
                        "60",
                        "55",
                        "45"
                    ],
                    correctAnswer: 0 // الفهرس 0 يعني الخيار الأول (أ)
                },
                {
                    id: 3,
                    text: "3. 35 ÷ (6 - (5 - 4)) = ......",
                    options: [
                        "6",
                        "7",
                        "5",
                        "8"
                    ],
                    correctAnswer: 1 // الفهرس 1 يعني الخيار الثاني (ب)
                },
                {
                    id: 4,
                    text: "4. إذا كان المدخل 7 والقاعدة هي ن × 5 فإن المخرج هو .................",
                    options: [
                        "12",
                        "35",
                        "57",
                        "75"
                    ],
                    correctAnswer: 1 // الفهرس 1 يعني الخيار الثاني (ب)
                },
                {
                    id: 5,
                    text: "5. قاعدة النمط 7، 12، 17، 22، ... هي .................",
                    options: [
                        "جمع 5",
                        "طرح 5",
                        "جمع 6",
                        "ضرب 2"
                    ],
                    correctAnswer: 0 // الفهرس 0 يعني الخيار الأول (أ)
                },
                {
                    id: 6,
                    text: "6. خارج قسمة 2.5 ÷ 0.5 يساوي.....................",
                    options: [
                        "5",
                        "8",
                        "22",
                        "10"
                    ],
                    correctAnswer: 0 // الفهرس 0 يعني الخيار الأول (أ)
                },
                {
                    id: 7,
                    text: "7. 3.5 ÷ 0.1 = ......",
                    options: [
                        "35",
                        "3500",
                        "3.5",
                        "0.35"
                    ],
                    correctAnswer: 0 // الفهرس 0 يعني الخيار الأول (أ)
                },
                {
                    id: 8,
                    text: "8. 512 جم = ................... كجم",
                    options: [
                        "5.12",
                        "512",
                        "51.20",
                        "0.512"
                    ],
                    correctAnswer: 3 // الفهرس 3 يعني الخيار الرابع (د)
                },
                {
                    id: 9,
                    text: "9. المقسوم عليه في مسألة القسمة 2499 ÷ 51 = 49 هو..................",
                    options: [
                        "49",
                        "2499",
                        "51",
                        "0"
                    ],
                    correctAnswer: 2 // الفهرس 2 يعني الخيار الثالث (ج)
                },
                {
                    id: 10,
                    text: "10. 0.7 × ...... = 70",
                    options: [
                        "1",
                        "10",
                        "100",
                        "1000"
                    ],
                    correctAnswer: 2 // الفهرس 2 يعني الخيار الثالث (ج)
                }
            ]
        };

        // متغيرات النظام
        let currentScreen = 'code';
        let studentAnswers = {};
        let examTime = 30 * 60; // 30 دقيقة بالثواني
        let timerInterval;
        let currentCode = '';
        
        // تهيئة النظام
        document.addEventListener('DOMContentLoaded', function() {
            // تحديث الوقت الحالي
            updateCurrentTime();
            setInterval(updateCurrentTime, 1000);
            
            // أحداث الأزرار
            document.getElementById('start-exam').addEventListener('click', startExam);
            document.getElementById('submit-exam').addEventListener('click', submitExam);
            document.getElementById('restart-btn').addEventListener('click', restartSystem);
            
            // التحقق من الكود عند الضغط على Enter
            document.getElementById('student-code').addEventListener('keyup', function(event) {
                if (event.key === 'Enter') {
                    startExam();
                }
            });
            
            // إعداد الأسئلة
            setupExamQuestions();
            
            // التحقق من الوقت الحالي
            checkCurrentTime();
        });
        
        // تحديث الوقت الحالي
        function updateCurrentTime() {
            const now = new Date();
            const timeString = now.toLocaleTimeString('ar-EG');
            document.getElementById('current-time').textContent = `الوقت الحالي: ${timeString}`;
        }
        
        // التحقق من الوقت الحالي (لا يسمح بعد منتصف الليل)
        function checkCurrentTime() {
            const now = new Date();
            const hours = now.getHours();
            
            if (hours >= 24 || hours < 6) { // بعد منتصف الليل حتى 6 صباحًا
                document.getElementById('time-error').style.display = 'block';
                document.getElementById('start-exam').disabled = true;
                return false;
            }
            return true;
        }
        
        // بدء الامتحان بعد التحقق من الكود
        function startExam() {
            // التحقق من الوقت أولاً
            if (!checkCurrentTime()) {
                return;
            }
            
            const codeInput = document.getElementById('student-code');
            const code = codeInput.value.trim();
            
            // التحقق من صحة الكود
            if (!isValidCode(code)) {
                showError('code-error');
                return;
            }
            
            // حفظ الكود الحالي
            currentCode = code;
            
            // التحقق من استخدام الكود من قبل على هذا الهاتف
            if (isCodeUsed(code)) {
                showError('code-error');
                return;
            }
            
            // التحقق من عدد المرات التي استخدم فيها الهاتف
            if (isPhoneLimitReached()) {
                showError('phone-limit-error');
                return;
            }
            
            // تسجيل الكود والهاتف
            registerCodeAndPhone(code);
            
            // إخفاء أي رسائل خطأ
            hideAllErrors();
            
            // عرض رسالة نجاح
            document.getElementById('code-success').style.display = 'block';
            
            // الانتقال للامتحان بعد تأخير قصير
            setTimeout(() => {
                switchScreen('exam');
                startTimer();
            }, 1000);
        }
        
        // التحقق من صحة الكود (9 أرقام إنجليزية فقط)
        function isValidCode(code) {
            const codeRegex = /^\d{9}$/;
            return codeRegex.test(code);
        }
        
        // التحقق من استخدام الكود من قبل على هذا الهاتف
        function isCodeUsed(code) {
            // إنشاء معرف فريد للهاتف باستخدام مزيج من خصائص المتصفح
            const phoneId = generatePhoneId();
            
            // إنشاء مفتاح تخزين مميز لهذا الامتحان
            const storageKey = `math_exam_5th_${phoneId}`;
            
            // محاولة قراءة البيانات المخزنة
            const storedData = localStorage.getItem(storageKey);
            
            if (storedData) {
                try {
                    const data = JSON.parse(storedData);
                    // التحقق إذا كان الكود موجود في القائمة
                    if (data.codes && data.codes.includes(code)) {
                        return true;
                    }
                } catch (e) {
                    // في حالة وجود خطأ في البيانات، نعتبر أنها غير موجودة
                    return false;
                }
            }
            
            return false;
        }
        
        // التحقق من وصول الهاتف للحد الأقصى (مرتين فقط)
        function isPhoneLimitReached() {
            const phoneId = generatePhoneId();
            const storageKey = `math_exam_5th_${phoneId}`;
            
            const storedData = localStorage.getItem(storageKey);
            
            if (storedData) {
                try {
                    const data = JSON.parse(storedData);
                    if (data.codes && data.codes.length >= 2) {
                        return true;
                    }
                } catch (e) {
                    return false;
                }
            }
            
            return false;
        }
        
        // تسجيل الكود والهاتف
        function registerCodeAndPhone(code) {
            const phoneId = generatePhoneId();
            const storageKey = `math_exam_5th_${phoneId}`;
            
            let data = {
                codes: [],
                lastAccess: new Date().toISOString()
            };
            
            const storedData = localStorage.getItem(storageKey);
            if (storedData) {
                try {
                    data = JSON.parse(storedData);
                } catch (e) {
                    // تجاهل الخطأ ونبدأ من جديد
                }
            }
            
            // إضافة الكود الجديد إذا لم يكن موجودًا
            if (!data.codes.includes(code)) {
                data.codes.push(code);
                data.lastAccess = new Date().toISOString();
                
                // حفظ البيانات
                localStorage.setItem(storageKey, JSON.stringify(data));
            }
        }
        
        // إنشاء معرف فريد للهاتف
        function generatePhoneId() {
            // استخدام مزيج من خصائص المتصفح لإنشاء معرف فريد
            const userAgent = navigator.userAgent;
            const language = navigator.language;
            const timezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
            
            // إنشاء هاش بسيط
            let hash = 0;
            const str = `${userAgent}|${language}|${timezone}`;
            
            for (let i = 0; i < str.length; i++) {
                const char = str.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash; // تحويل إلى 32-bit integer
            }
            
            // إضافة بادئة مميزة لهذا الامتحان
            return `exam5_${Math.abs(hash).toString(16).substring(0, 8)}`;
        }
        
        // إعداد أسئلة الامتحان
        function setupExamQuestions() {
            const examForm = document.getElementById('exam-form');
            const arabicLetters = ['أ', 'ب', 'ج', 'د'];
            
            examData.questions.forEach((question, index) => {
                const questionDiv = document.createElement('div');
                questionDiv.className = 'question';
                
                let optionsHTML = '';
                question.options.forEach((option, optIndex) => {
                    optionsHTML += `
                        <div class="option" data-question="${question.id}" data-option="${optIndex}">
                            <span class="option-label">${arabicLetters[optIndex]}</span>
                            ${option}
                        </div>
                    `;
                });
                
                questionDiv.innerHTML = `
                    <div class="question-number">${question.text}</div>
                    <div class="options" id="options-${question.id}">
                        ${optionsHTML}
                    </div>
                `;
                
                examForm.appendChild(questionDiv);
            });
            
            // إضافة أحداث لخيارات الأسئلة
            document.querySelectorAll('.option').forEach(option => {
                option.addEventListener('click', function() {
                    const questionId = parseInt(this.getAttribute('data-question'));
                    const optionIndex = parseInt(this.getAttribute('data-option'));
                    
                    // إزالة التحديد من جميع خيارات هذا السؤال
                    const allOptions = document.querySelectorAll(`[data-question="${questionId}"]`);
                    allOptions.forEach(opt => opt.classList.remove('selected'));
                    
                    // تحديد الخيار الحالي
                    this.classList.add('selected');
                    
                    // حفظ إجابة الطالب
                    studentAnswers[questionId] = optionIndex;
                });
            });
        }
        
        // بدء المؤقت
        function startTimer() {
            clearInterval(timerInterval);
            
            timerInterval = setInterval(() => {
                examTime--;
                
                const minutes = Math.floor(examTime / 60);
                const seconds = examTime % 60;
                
                document.getElementById('time-left').textContent = 
                    `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                
                // انتهاء الوقت
                if (examTime <= 0) {
                    clearInterval(timerInterval);
                    submitExam();
                }
            }, 1000);
        }
        
        // تقديم الامتحان
        function submitExam() {
            clearInterval(timerInterval);
            
            // حساب النتيجة
            const result = calculateResult();
            
            // عرض النتيجة
            showResult(result);
            
            // الانتقال لشاشة النتيجة
            switchScreen('result');
        }
        
        // حساب النتيجة
        function calculateResult() {
            let score = 0;
            const mistakes = [];
            const arabicLetters = ['أ', 'ب', 'ج', 'د'];
            
            examData.questions.forEach(question => {
                const studentAnswer = studentAnswers[question.id];
                const correctAnswer = question.correctAnswer;
                
                if (studentAnswer === correctAnswer) {
                    score++;
                } else {
                    const studentLetter = studentAnswer !== undefined ? 
                        arabicLetters[studentAnswer] : 'لم يتم الإجابة';
                    const correctLetter = arabicLetters[correctAnswer];
                    
                    mistakes.push({
                        question: question.text,
                        studentAnswer: studentLetter + '. ' + (studentAnswer !== undefined ? 
                            question.options[studentAnswer] : 'لم يتم الإجابة'),
                        correctAnswer: correctLetter + '. ' + question.options[correctAnswer]
                    });
                }
            });
            
            return {
                score: score,
                total: examData.questions.length,
                mistakes: mistakes
            };
        }
        
        // عرض النتيجة
        function showResult(result) {
            document.getElementById('final-grade').textContent = `${result.score}/${result.total}`;
            
            const mistakesContainer = document.getElementById('mistakes-container');
            
            if (result.mistakes.length === 0) {
                mistakesContainer.innerHTML = '<p style="color: #38a169; font-weight: bold;">تهانينا! لم ترتكب أي أخطاء.</p>';
            } else {
                let mistakesHTML = '<h3>الأخطاء التي وقعت فيها:</h3>';
                
                result.mistakes.forEach((mistake, index) => {
                    mistakesHTML += `
                        <div class="mistake-item">
                            <p><strong>السؤال:</strong> ${mistake.question}</p>
                            <p><strong>إجابتك:</strong> <span class="student-answer">${mistake.studentAnswer}</span></p>
                            <p><strong>الإجابة الصحيحة:</strong> <span class="correct-answer">${mistake.correctAnswer}</span></p>
                        </div>
                    `;
                });
                
                mistakesContainer.innerHTML = mistakesHTML;
            }
        }
        
        // تبديل الشاشات
        function switchScreen(screen) {
            // إخفاء جميع الشاشات
            document.querySelectorAll('.card').forEach(card => {
                card.classList.remove('active');
            });
            
            // إظهار الشاشة المطلوبة
            document.getElementById(`${screen}-screen`).classList.add('active');
            currentScreen = screen;
        }
        
        // إعادة تشغيل النظام
        function restartSystem() {
            // إعادة تعيين المتغيرات
            studentAnswers = {};
            examTime = 30 * 60;
            currentCode = '';
            
            // إعادة تعيين النموذج
            document.querySelectorAll('.option').forEach(option => {
                option.classList.remove('selected');
            });
            
            // إعادة تعيين حقل الكود
            document.getElementById('student-code').value = '';
            
            // إخفاء الرسائل
            hideAllErrors();
            document.getElementById('code-success').style.display = 'none';
            
            // العودة لشاشة الكود
            switchScreen('code');
        }
        
        // عرض رسالة خطأ
        function showError(errorId) {
            hideAllErrors();
            document.getElementById(errorId).style.display = 'block';
        }
        
        // إخفاء جميع رسائل الخطأ
        function hideAllErrors() {
            document.querySelectorAll('.error-message, .success-message').forEach(msg => {
                msg.style.display = 'none';
            });
        }
    </script>
</body>
</html>
